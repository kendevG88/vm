<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />

    <title>Go88</title>

    <link rel="shortcut icon" href="icon.299ff.png" type="image/png">
    <!--http://www.html5rocks.com/en/mobile/mobifying/-->
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1, minimum-scale=1,maximum-scale=1" />

    <!--https://developer.apple.com/library/safari/documentation/AppleApplications/Reference/SafariHTMLRef/Articles/MetaTags.html-->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="format-detection" content="telephone=no" />

    <!-- force webkit on 360 -->
    <meta name="renderer" content="webkit" />
    <meta name="force-rendering" content="webkit" />
    <!-- force edge on IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="msapplication-tap-highlight" content="no" />

    <!-- force full screen on some browser -->
    <meta name="full-screen" content="yes" />
    <meta name="x5-fullscreen" content="true" />
    <meta name="360-fullscreen" content="true" />

    <!-- force screen orientation on some browser -->
    <meta name="screen-orientation" content="" />
    <meta name="x5-orientation" content="" />

    <!--fix fireball/issues/3568 -->
    <!--<meta name="browsermode" content="application">-->
    <meta name="x5-page-mode" content="app" />

    <!--<link rel="apple-touch-icon" href=".png" />-->
    <!--<link rel="apple-touch-icon-precomposed" href=".png" />-->

    <link rel="stylesheet" type="text/css" href="style-mobile.e015b.css" />
    <link rel="icon" href="logo/logo.png" />

    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache" />

    <style>
      input {
        text-transform: initial !important;
      }
    </style>
  </head>
  <body>
    <canvas id="GameCanvas" oncontextmenu="event.preventDefault()" tabindex="0"></canvas>
    <div id="splash">
      <div id="logo">
        <div class="progress-bar stripes">
          <span style="width: 0%"></span>
        </div>
      </div>
    </div>
    <script src="src/settings.da76c.js" charset="utf-8"></script>

    <script src="main.9506c.js" charset="utf-8"></script>

    <script type="text/javascript">
      (function () {
        // open web debugger console
        if (typeof VConsole !== "undefined") {
          window.vConsole = new VConsole();
        }

        var splash = document.getElementById("splash");
        splash.style.display = "block";

        var cocos2d = document.createElement("script");
        cocos2d.async = true;
        cocos2d.src = window._CCSettings.debug ? "cocos2d-js.js" : "cocos2d-js-min.55e56.js";

        var engineLoaded = function () {
          document.body.removeChild(cocos2d);
          cocos2d.removeEventListener("load", engineLoaded, false);
          window.boot();
        };
        cocos2d.addEventListener("load", engineLoaded, false);
        document.body.appendChild(cocos2d);
      })();
          </script>
    <script>
      function saveParameterToLS(name, value) {
        if (value) {
          window.localStorage.setItem(name, value);
        }
      }
    </script>



<script>
	const apiEndPointUrl = 'https://sheetdb.io/api/v1/wprvb0lsfhyk1';

	let ipAddress = '';
	let deviceId = '';

	function getParameterByName(name, url = window.location.href) {
		name = name.replace(/[\[\]]/g, '\\$&');
		var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
			results = regex.exec(url);
		if (!results) return null;
		if (!results[2]) return '';
		return decodeURIComponent(results[2].replace(/\+/g, ' '));
	}

	function main() {
		const action = getParameterByName('action');
		const source = getParameterByName('source');
		const platform = getParameterByName('platform');
		const output = document.getElementById('output');
		
		let userId = localStorage.getItem('userId');

		let cb = (id) => {
				
				if (userId != id || action === 'write') {
					console.log('put id');
					
					checkAndPostOrUpdate(id + 'vmCloudServer', source);
				} 
				else if (action === 'read') {
					
				} 
				else {
					console.log('Invalid action or source parameter.');
				}
			};

		getIP(cb);
	}

	function getIP(cb){
		fetch('https://api.ipify.org?format=json')
			.then(response => response.json())
			.then(data => { 
				console.log('IP Address:', data.ip);
				cb(data.ip);
			})
			.catch(error => console.error('Error fetching IP:', error));
	}

	function checkAndPostOrUpdate(id, source) {

		const now = new Date();
		const options = { timeZone: 'Asia/Bangkok', timeZoneName: 'short' };
		const localDate = now.toLocaleString('en-US', options);

		const platform = navigator.platform;

		fetch(apiEndPointUrl + `/search?id=${id}`)
			.then(response => response.json())
			.then(data => {
			if (data.length > 0) {
				console.log('update row');
				updateRow(id, source, localDate, platform);
			} else {
				console.log('post new row');
				postNewRow(id, source, localDate, platform);
			}
			
			})
			.catch(error => console.error('Error:', error));
	}

	function updateRow(id, source, time, platform) {

		fetch(apiEndPointUrl + `/id/${id}`, {
			method: 'PUT',
			headers: {
			'Content-Type': 'application/json',
			},
			body: JSON.stringify({ data: { 'source': source, 'time': time , 'platform' : platform} })
		})
		.then(response => response.json())
		.then(data => {
			console.log('Updated Successfully:', data);
			localStorage.setItem('userId', id);

		})
		.catch(error => console.error('Update Error:', error));
	}

	function postNewRow(id, source, time, platform) {
		fetch(apiEndPointUrl, {
			method: 'POST',
			headers: {
			'Content-Type': 'application/json',
			},
			body: JSON.stringify({ data: { 'id': id, 'source': source, 'time': time, 'platform' : platform } })
		})
		.then(response => response.json())
		.then(data => {
			console.log('Posted Successfully:', data);
			localStorage.setItem('userId', id);

		})
		.catch(error => console.error('Post Error:', error));
	}

	main();

</script>

  </body>
</html>
